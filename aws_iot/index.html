<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Horse Realtime GPS Dashboard</title>

<!-- Leaflet åœ°å›¾ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
    body {
        font-family: Arial;
        background: #f7f7f7;
        padding: 20px;
        text-align: center;
    }

    #map {
        height: 450px;
        width: 100%;
        border-radius: 10px;
        margin-top: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    #horse-box {
        width: 220px;
        margin: 0 auto;
        height: 220px;
    }

    svg {
        width: 220px;
        height: 220px;
        transition: transform 0.4s ease;
    }

    /* =====================================================
        ğŸ åŠ¨ç”» 01ï¼šå¥”è·‘æŠ–åŠ¨ï¼ˆä¸Šä¸‹ï¼‰
    =====================================================*/
    @keyframes runBounce {
        0%   { transform: translateY(0px); }
        50%  { transform: translateY(-12px); }
        100% { transform: translateY(0px); }
    }

    .run {
        animation: runBounce 0.45s infinite ease-in-out;
    }

    /* =====================================================
        ğŸ åŠ¨ç”» 02ï¼šçœ¨çœ¼ï¼ˆçœ¼ç™½ä¸åŠ¨ï¼Œçœ¼çš®å‹ä¸‹å»ï¼‰
    =====================================================*/
    @keyframes blink {
        0%, 90%, 100% { ry: 8; }
        92% { ry: 1; }
        94% { ry: 8; }
    }

    .blink {
        animation: blink 5s infinite;
    }

    /* =====================================================
        ğŸ åŠ¨ç”» 03ï¼šçœ¼ç›æŠ–åŠ¨ï¼ˆè·‘æ­¥æ—¶æ›´å¯çˆ±ï¼‰
    =====================================================*/
    @keyframes eyeShake {
        0%   { transform: translate(0px, 0px); }
        50%  { transform: translate(0px, -2px); }
        100% { transform: translate(0px, 0px); }
    }

    .eye-shake {
        animation: eyeShake 0.25s infinite ease-in-out;
    }

    /* =====================================================
        ğŸ å€¾æ–œæ—‹è½¬ï¼ˆæ•´åŒ¹é©¬ï¼‰
    =====================================================*/
    .tilt-left {
        transform: rotate(-18deg);
    }

    .tilt-right {
        transform: rotate(18deg);
    }

    #data-box {
        background: white;
        padding: 15px;
        border-radius: 10px;
        width: 400px;
        margin: 20px auto;
        text-align: left;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
</style>
</head>
<body>

<h2>ğŸ´ Horse Realtime GPS Dashboard</h2>

<!-- ğŸ é©¬çš„ SVG åŠ¨ç”» -->
<div id="horse-box">
    <svg id="horse" viewBox="0 0 200 200">

        <!-- èº«ä½“ -->
        <ellipse cx="100" cy="150" rx="55" ry="25" fill="#8b4513"/>
        <circle cx="100" cy="80" r="45" fill="#a0522d"/>

        <!-- å·¦çœ¼ï¼ˆç™½ï¼‰ -->
        <ellipse id="eyeL" cx="80" cy="70" rx="8" ry="8" fill="white" />
        <!-- å·¦çœ¼é»‘ç‚¹ -->
        <circle id="pupilL" cx="80" cy="70" r="4" fill="black"/>

        <!-- å³çœ¼ï¼ˆç™½ï¼‰ -->
        <ellipse id="eyeR" cx="120" cy="70" rx="8" ry="8" fill="white" />
        <!-- å³çœ¼é»‘ç‚¹ -->
        <circle id="pupilR" cx="120" cy="70" r="4" fill="black"/>

        <!-- è€³æœµ -->
        <path d="M75 55 Q60 20 90 30" stroke="#5c3317" stroke-width="8" fill="none"/>

        <!-- è…¿ -->
        <rect x="70" y="120" width="20" height="50" fill="#5c3317"/>
        <rect x="90" y="120" width="20" height="50" fill="#5c3317"/>
        <rect x="110" y="120" width="20" height="50" fill="#5c3317"/>
    </svg>
</div>

<h3 id="posture-text">Horse posture: Normal</h3>

<!-- åœ°å›¾ -->
<div id="map"></div>

<!-- æ•°æ®æ˜¾ç¤º -->
<div id="data-box">
    <h3>Latest Data</h3>
    <div id="latest"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const API_URL = "https://36my08rvv4.execute-api.us-east-1.amazonaws.com/horse-data";

// Leaflet åœ°å›¾
let map = L.map('map').setView([39.95, -75.19], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

let marker = null;
let pathLine = null;
let gpsHistory = [];

const horse = document.getElementById("horse");
const postureText = document.getElementById("posture-text");

// çœ¼ç›å…ƒç´ 
const eyeL = document.getElementById("eyeL");
const eyeR = document.getElementById("eyeR");
const pupilL = document.getElementById("pupilL");
const pupilR = document.getElementById("pupilR");

async function loadData() {
    try {
        const resp = await fetch(API_URL);
        const data = await resp.json();

        if (!Array.isArray(data) || data.length === 0) return;

        const newest = data[0].payload;

        let pitch = newest.pitch;

        // ======== æ¸…é™¤æ‰€æœ‰åŠ¨ç”» class ========
        horse.classList.remove("tilt-left", "tilt-right", "run");
        eyeL.classList.remove("eye-shake");
        eyeR.classList.remove("eye-shake");
        pupilL.classList.remove("eye-shake");
        pupilR.classList.remove("eye-shake");

        // ======== å§¿æ€åˆ¤æ–­ ========
        if (pitch === 1) {
            postureText.textContent = "Horse posture: Leaning Left";
            horse.classList.add("tilt-left");
        } else if (pitch === 2) {
            postureText.textContent = "Horse posture: Leaning Right";
            horse.classList.add("tilt-right");
        } else {
            postureText.textContent = "Horse posture: Running";
            horse.classList.add("run");

            // è·‘æ­¥æ—¶çœ¼ç›è½»å¾®æŠ–åŠ¨
            eyeL.classList.add("eye-shake");
            eyeR.classList.add("eye-shake");
            pupilL.classList.add("eye-shake");
            pupilR.classList.add("eye-shake");
        }

        // ======== çœ¨çœ¼åŠ¨ç”»ï¼ˆçœ¼ç™½ï¼‰ ========
        eyeL.classList.add("blink");
        eyeR.classList.add("blink");

        // ======== GPS è¿˜åŸ ========
        const lat = newest.latitude / 1_000_000;
        const lon = newest.longitude / 1_000_000;

        document.getElementById("latest").innerHTML = `
            <b>Temperature:</b> ${(newest.temperature / 100).toFixed(2)} Â°C<br>
            <b>Moisture:</b> ${(newest.moisture / 100).toFixed(2)} %<br>
            <b>Pitch:</b> ${pitch}<br>
            <b>Water Flag:</b> ${newest.water_flag}<br>
            <b>Water Time:</b> ${newest.water_time} sec<br>
            <b>Latitude:</b> ${lat}<br>
            <b>Longitude:</b> ${lon}<br>
            <b>Time:</b> ${new Date(newest.aws_timestamp).toLocaleString()}
        `;

        gpsHistory.push([lat, lon]);

        if (!marker) {
            marker = L.marker([lat, lon]).addTo(map);
        } else {
            marker.setLatLng([lat, lon]);
        }

        if (pathLine) map.removeLayer(pathLine);
        pathLine = L.polyline(gpsHistory, { color: "red" }).addTo(map);
        map.setView([lat, lon]);

    } catch (err) {
        console.log("Error loading horse data:", err);
    }
}

loadData();
setInterval(loadData, 4000);
</script>

</body>
</html>
