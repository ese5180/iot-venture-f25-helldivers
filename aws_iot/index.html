<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Horse Realtime GPS Dashboard</title>

<!-- Leaflet åœ°å›¾ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
    body {
        font-family: Arial;
        background: #f7f7f7;
        padding: 20px;
        text-align: center;
    }

    #map {
        height: 450px;
        width: 100%;
        border-radius: 10px;
        margin-top: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    #latest-box {
        background: white;
        padding: 20px;
        width: 350px;
        margin: 30px auto;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        text-align: left;
    }

    #horse-img {
        width: 120px;
        height: auto;
        margin-top: 10px;
    }

</style>
</head>
<body>

<h2>ğŸ´ Horse Realtime GPS Dashboard</h2>

<!-- åŠ¨æ€é©¬çš„å§¿æ€å›¾ -->
<img id="horse-img" src="" alt="Horse">
<div id="posture-text" style="font-size: 20px; font-weight: bold; margin-top: 10px;">
    Horse posture: Normal
</div>

<div id="map"></div>

<div id="latest-box">
    <h3>Latest Data</h3>
    <div id="latest"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const API_URL = "https://36my08rvv4.execute-api.us-east-1.amazonaws.com/horse-data";

/* ä½ çš„é©¬å§¿æ€å›¾ç‰‡ï¼ˆä¸ä¼š404ï¼‰ */
const IMG_NORMAL = "https://i.imgur.com/6YVxZ1z.png";    
const IMG_LEFT   = "https://i.imgur.com/9YEaN7J.png";    
const IMG_RIGHT  = "https://i.imgur.com/uO7b51S.png";   

let map = L.map('map').setView([39.95, -75.19], 14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
}).addTo(map);

let marker = null;
let pathLine = null;
let gpsHistory = [];

/* å§¿æ€è½¬æ¢æ–‡å­— */
function getPostureText(pitch) {
    switch (pitch) {
        case 1: return "Leaning Left";
        case 2: return "Leaning Right";
        default: return "Normal";
    }
}

/* å§¿æ€é€‰æ‹©å›¾ç‰‡ */
function getHorseImage(pitch) {
    switch (pitch) {
        case 1: return IMG_LEFT;
        case 2: return IMG_RIGHT;
        default: return IMG_NORMAL;
    }
}

async function loadData() {
    try {
        const resp = await fetch(API_URL);
        const list = await resp.json();
        if (!Array.isArray(list) || list.length === 0) return;

        const newest = list[0].payload;

        /* pitch ç°åœ¨æ˜¯çŠ¶æ€å€¼ï¼Œä¸é™¤ä»¥100 */
        const pitch = newest.pitch;

        const lat = newest.latitude / 1_000_000;
        const lon = newest.longitude / 1_000_000;

        /* æ›´æ–°å§¿æ€å›¾æ ‡ & æ–‡å­— */
        document.getElementById("horse-img").src = getHorseImage(pitch);
        document.getElementById("posture-text").innerText = "Horse posture: " + getPostureText(pitch);

        /* æ˜¾ç¤ºæœ€æ–°æ•°æ®ï¼ˆä¸å†é™¤100ï¼‰ */
        document.getElementById("latest").innerHTML = `
            <b>Temperature:</b> ${(newest.temperature / 100).toFixed(2)} Â°C<br>
            <b>Moisture:</b> ${(newest.moisture / 100).toFixed(2)} %<br>
            <b>Pitch:</b> ${pitch} (${getPostureText(pitch)})<br>
            <b>Water Flag:</b> ${newest.water_flag}<br>
            <b>Water Time:</b> ${newest.water_time} sec<br>
            <b>Latitude:</b> ${lat.toFixed(6)}<br>
            <b>Longitude:</b> ${lon.toFixed(6)}<br>
            <b>Time:</b> ${new Date(newest.aws_timestamp).toLocaleString()}
        `;

        gpsHistory.push([lat, lon]);

        if (!marker) {
            marker = L.marker([lat, lon]).addTo(map);
        } else {
            marker.setLatLng([lat, lon]);
        }

        map.setView([lat, lon]);

        if (pathLine) map.removeLayer(pathLine);
        pathLine = L.polyline(gpsHistory, {color: "red"}).addTo(map);

    } catch (err) {
        console.log("load error:", err);
    }
}

loadData();
setInterval(loadData, 4000);
</script>

</body>
</html>
