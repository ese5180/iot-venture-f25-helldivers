<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Horse Realtime GPS Dashboard</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f7f7f7;
        padding: 20px;
        text-align: center;
        margin: 0;
    }

    h1, h2, h3 {
        margin: 0.3rem 0;
    }

    /* é¡¶éƒ¨é©¬åŠ¨ç”»åŒºåŸŸ */
    #horse-box {
        width: 220px;
        margin: 0 auto 5px auto;
        height: 220px;
    }

    #horse {
        width: 220px;
        height: 220px;
        transform-origin: 110px 140px; /* æ—‹è½¬ä¸­å¿ƒï¼ˆå¤§æ¦‚åœ¨é©¬èº«ä½“ä¸­éƒ¨ï¼‰ */
        transition: transform 0.4s ease;
    }

    /* çœ¼ç›é€šç”¨ class */
    .eye {
        transform-origin: center;
        animation: blink 4s infinite;
    }

    /* çœ¨çœ¼åŠ¨ç”» */
    @keyframes blink {
        0%, 88%, 100% { transform: scaleY(1); }
        90%           { transform: scaleY(0.15); }
        92%           { transform: scaleY(1); }
    }

    /* è·‘æ­¥ä¸Šä¸‹è·³åŠ¨ */
    @keyframes run-bounce {
        0%   { transform: translateY(0px); }
        50%  { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }

    /* è·‘æ­¥æ—¶çœ¼ç›è½»å¾®æŠ–åŠ¨ */
    @keyframes eye-jitter {
        0%, 100% { transform: translateX(0px); }
        50%      { transform: translateX(1.2px); }
    }

    .run {
        animation: run-bounce 0.5s infinite ease-in-out;
    }

    .run .eye {
        animation: blink 4s infinite, eye-jitter 0.25s infinite;
    }

    /* å·¦å³å€¾æ–œ */
    .tilt-left {
        transform: rotate(-18deg);
    }
    .tilt-right {
        transform: rotate(18deg);
    }

    /* åœ°å›¾åŒºåŸŸå¸ƒå±€ï¼šå¤§å±å·¦å³å¹¶æ’ï¼Œå°å±ä¸Šä¸‹å †å  */
    #maps-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-top: 16px;
        justify-content: center;
    }

    .map-container {
        flex: 1 1 420px;
        min-width: 320px;
        max-width: 700px;
    }

    .map-title {
        font-weight: bold;
        margin-bottom: 6px;
    }

    .map-box {
        height: 360px;
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    /* æœ€æ–°æ•°æ®å¡ç‰‡ */
    #data-box {
        background: white;
        padding: 15px;
        border-radius: 10px;
        width: 420px;
        margin: 20px auto;
        text-align: left;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        font-size: 0.95rem;
    }

    #data-box b {
        font-weight: 600;
    }

    @media (max-width: 600px) {
        #data-box {
            width: 90%;
        }
    }
</style>
</head>
<body>

<h2>ğŸ´ Horse Realtime GPS Dashboard</h2>

<!-- SVG å¡é€šé©¬ -->
<div id="horse-box">
    <svg id="horse" viewBox="0 0 200 200">
        <!-- åœ°é¢æ¤­åœ† -->
        <ellipse cx="100" cy="155" rx="55" ry="24" fill="#8b4513"/>
        <!-- èº«ä½“ -->
        <rect x="80" y="110" width="40" height="55" rx="8" fill="#5c3317"/>
        <!-- å¤´éƒ¨ -->
        <circle cx="100" cy="80" r="45" fill="#a0522d"/>

        <!-- å·¦çœ¼ -->
        <g class="eye">
            <circle cx="85" cy="70" r="8" fill="white"/>
            <circle cx="86" cy="70" r="4" fill="black"/>
        </g>
        <!-- å³çœ¼ -->
        <g class="eye">
            <circle cx="115" cy="70" r="8" fill="white"/>
            <circle cx="116" cy="70" r="4" fill="black"/>
        </g>

        <!-- è€³æœµ/é¬ƒæ¯› -->
        <path d="M80 50 Q65 20 95 30" stroke="#5c3317" stroke-width="8" fill="none" stroke-linecap="round"/>

        <!-- å‰è…¿ -->
        <rect x="85" y="135" width="10" height="35" fill="#3f2613"/>
        <rect x="105" y="135" width="10" height="35" fill="#3f2613"/>
    </svg>
</div>

<h3 id="posture-text">Horse posture: Running</h3>

<!-- ä¸¤å¼ åœ°å›¾ï¼šå·¦æ™®é€šä½ç½®ï¼Œå³æ°´æºä½ç½® -->
<div id="maps-wrapper">
    <div class="map-container">
        <div class="map-title">Latest Normal Position (water_flag = 0)</div>
        <div id="mapNormal" class="map-box"></div>
    </div>
    <div class="map-container">
        <div class="map-title">Latest Water Source Position (water_flag = 1)</div>
        <div id="mapWater" class="map-box"></div>
    </div>
</div>

<!-- æœ€æ–°æ•°æ® -->
<div id="data-box">
    <h3>Latest Data</h3>
    <div id="latest"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const API_URL = "https://36my08rvv4.execute-api.us-east-1.amazonaws.com/horse-data";

// åˆå§‹åŒ–ä¸¤å¼ åœ°å›¾
const mapNormal = L.map('mapNormal').setView([39.95, -75.19], 12);
const mapWater  = L.map('mapWater').setView([39.95, -75.19], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(mapNormal);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(mapWater);

let normalMarker = null;
let waterMarker  = null;

const horse       = document.getElementById("horse");
const postureText = document.getElementById("posture-text");

function applyHorsePosture(pitch) {
    // pitch: 0=æ­£å¸¸è·‘, 1=å·¦å€¾, 2=å³å€¾
    horse.classList.remove("tilt-left", "tilt-right", "run");

    if (pitch === 1) {
        postureText.textContent = "Horse posture: Leaning Left";
        horse.classList.add("tilt-left");
    } else if (pitch === 2) {
        postureText.textContent = "Horse posture: Leaning Right";
        horse.classList.add("tilt-right");
    } else {
        postureText.textContent = "Horse posture: Running";
        horse.classList.add("run");
    }
}

async function loadData() {
    try {
        const resp = await fetch(API_URL);
        const raw  = await resp.json();

        if (!Array.isArray(raw) || raw.length === 0) {
            console.log("No data from API");
            return;
        }

        // è§£åŒ… payload
        const items = raw.map(d => d.payload ? d.payload : d);

        // æœ€æ–°ä¸€æ¡ï¼ˆç”¨äºé¡¶éƒ¨å§¿æ€ + info å¡ç‰‡ï¼‰
        const newest = items[0];

        const latNewest = newest.latitude  / 1_000_000;
        const lonNewest = newest.longitude / 1_000_000;

        // é©¬çš„å§¿æ€
        applyHorsePosture(newest.pitch);

        // æœ€æ–°æ•°æ®å¡ç‰‡
        document.getElementById("latest").innerHTML = `
            <b>Temperature:</b> ${(newest.temperature / 100).toFixed(2)} Â°C<br>
            <b>Moisture:</b> ${(newest.moisture / 100).toFixed(2)} %<br>
            <b>Pitch (state):</b> ${newest.pitch}<br>
            <b>Water Flag:</b> ${newest.water_flag}<br>
            <b>Water Time:</b> ${newest.water_time} sec<br>
            <b>Latitude:</b> ${latNewest.toFixed(6)}<br>
            <b>Longitude:</b> ${lonNewest.toFixed(6)}<br>
            <b>Time:</b> ${new Date(newest.aws_timestamp).toLocaleString()}
        `;

        // æ‰¾åˆ°â€œæœ€æ–°â€çš„ water_flag=0 å’Œ water_flag=1
        const latestNormal = items.find(it => it.water_flag === 0);
        const latestWater  = items.find(it => it.water_flag === 1);

        // ===== æ™®é€šä½ç½® (water_flag = 0) =====
        if (latestNormal) {
            const latN = latestNormal.latitude  / 1_000_000;
            const lonN = latestNormal.longitude / 1_000_000;

            if (!normalMarker) {
                normalMarker = L.marker([latN, lonN]).addTo(mapNormal);
            } else {
                normalMarker.setLatLng([latN, lonN]);
            }
            mapNormal.setView([latN, lonN], 13);
        }

        // ===== æ°´æºä½ç½® (water_flag = 1) =====
        if (latestWater) {
            const latW = latestWater.latitude  / 1_000_000;
            const lonW = latestWater.longitude / 1_000_000;

            if (!waterMarker) {
                // ç”¨çº¢è‰²å°åœ†å›¾æ ‡
                const waterIcon = L.icon({
                    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                    shadowSize: [41, 41]
                });
                waterMarker = L.marker([latW, lonW], { icon: waterIcon }).addTo(mapWater);
                waterMarker.bindPopup("Water source (latest water_flag = 1)");
            } else {
                waterMarker.setLatLng([latW, lonW]);
            }
            mapWater.setView([latW, lonW], 13);
        }

    } catch (e) {
        console.error("Error loading data:", e);
    }
}

// åˆæ¬¡åŠ è½½ + å®šæ—¶åˆ·æ–°
loadData();
setInterval(loadData, 5000);
</script>

</body>
</html>
