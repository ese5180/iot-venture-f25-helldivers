name: twister-tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  twister:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          df -h

      - name: Run Twister tests in Docker
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workdir" \
            -w /workdir \
            ghcr.io/zephyrproject-rtos/zephyr-build:main \
            bash -lc '
              set -eux

              # 一定要在 /workdir 里操作，这个目录就是你的 repo，具备写权限
              cd /workdir
              echo "PWD is $(pwd)"
              ls

              echo "=== Clone Zephyr repo for Twister ==="
              git clone --depth 1 https://github.com/zephyrproject-rtos/zephyr.git zephyr

              export ZEPHYR_BASE=/workdir/zephyr

              # 确保 Twister 依赖就绪（一般镜像里都有，这里保险起见）
              pip3 install -r zephyr/scripts/requirements-base.txt

              mkdir -p aws_iot_sensor/twister-out

              west twister \
                -p qemu_cortex_m3 \
                -T aws_iot_sensor/tests/balance \
                --inline-logs \
                --report-junit aws_iot_sensor/twister-out/twister.xml \
                --report-json  aws_iot_sensor/twister-out/twister.json
            '

      - name: Upload Twister artifacts
        uses: actions/upload-artifact@v4
        with:
          name: twister-out
          path: aws_iot_sensor/twister-out