name: Twister CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  twister-tests:
    runs-on: ubuntu-latest

    steps:
      # 1. 把你的项目 checkout 到子目录 project/
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: project

      # 2. 安装编译 Zephyr + native_sim 所需的一些包
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf \
            python3-dev python3-pip python3-setuptools python3-wheel \
            xz-utils file make gcc g++ \
            libsdl2-dev

      # 3. 初始化一个 Zephyr workspace（只为了跑 Twister）
      - name: Init Zephyr workspace
        run: |
          pip3 install --user west
          echo "$HOME/.local/bin" >> $GITHUB_PATH

          # 在仓库根目录下创建 zephyrproject/
          west init -m https://github.com/zephyrproject-rtos/zephyr --mr v4.0.0 zephyrproject
          cd zephyrproject
          west update --narrow
          pip3 install -r zephyr/scripts/requirements.txt

      # 4. 跑 Twister，指向你 aws_iot_sensor 里的 balance unit test
      - name: Run Twister horse balance tests
        working-directory: zephyrproject
        env:
          ZEPHYR_BASE: ${{ github.workspace }}/zephyrproject/zephyr
        run: |
          python3 zephyr/scripts/twister \
            -p native_sim/native/64 \
            -T $GITHUB_WORKSPACE/project/aws_iot_sensor/tests/balance \
            --outdir $GITHUB_WORKSPACE/twister-out-ci \
            --inline-logs

      # 5. 把 Twister 输出作为 artifact 上传，方便助教下载看
      - name: Upload Twister artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: twister-out
          path: twister-out-ci
